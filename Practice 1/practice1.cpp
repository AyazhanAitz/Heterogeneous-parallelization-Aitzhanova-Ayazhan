#include <iostream>
#include <cstdlib>
#include <ctime>
#include <omp.h>
#include <clocale>

using namespace std;

// Функция заполняет динамический массив случайными числами от 1 до 100
// arr — указатель на массив
// n — размер массива
void fillRandom(int* arr, int n) {
    // Запускаем цикл по всем элементам массива
    for (int i = 0; i < n; i++) {
        // Записываем в текущий элемент случайное число от 1 до 100
        arr[i] = 1 + rand() % 100;
    }
}

// Функция вычисляет среднее значение последовательно (без OpenMP)
// arr — указатель на массив
// n — размер массива
double averageSequential(const int* arr, int n) {
    // Переменная для суммы элементов (long long, чтобы сумма не переполнилась)
    long long sum = 0;
    // Цикл по всем элементам массива
    for (int i = 0; i < n; i++) {
        // Прибавляем текущий элемент к сумме
        sum += arr[i];
    }
    // Возвращаем среднее значение: сумма / количество
    return (double)sum / n;
}

// Функция вычисляет среднее значение параллельно с OpenMP
// arr — указатель на массив
// n — размер массива
double averageParallelOpenMP(const int* arr, int n) {
    // Переменная для суммы элементов (делаем long long)
    long long sum = 0;

    // Параллельный цикл: сумма считается в нескольких потоках
    // reduction(+:sum) означает: у каждого потока своя sum, потом они суммируются в одну
#pragma omp parallel for reduction(+:sum)
    // Цикл по всем элементам массива
    for (int i = 0; i < n; i++) {
        // Прибавляем элемент массива к сумме
        sum += arr[i];
    }

    // Возвращаем среднее значение
    return (double)sum / n;
}

// Главная функция программы
int main() {
    // Устанавливаем русскую локаль (чтобы русский текст корректно отображался)
    setlocale(LC_ALL, "Russian");

    // Объявляем переменную для размера массива
    int n;

    // Просим пользователя ввести размер массива
    cout << "Введите размер массива: ";
    // Считываем размер массива
    cin >> n;

    // Проверяем, что размер массива положительный
    if (n <= 0) {
        // Выводим сообщение об ошибке
        cout << "Ошибка: размер массива должен быть больше 0." << endl;
        // Завершаем программу
        return 0;
    }

    // Динамически выделяем память под массив из n целых чисел
    int* arr = new int[n];

    // Инициализируем генератор случайных чисел (зависит от текущего времени)
    srand((unsigned)time(nullptr));

    // Заполняем массив случайными числами
    fillRandom(arr, n);

    // Вычисляем среднее значение последовательно
    double avgSeq = averageSequential(arr, n);

    // Вычисляем среднее значение параллельно (OpenMP)
    double avgPar = averageParallelOpenMP(arr, n);

    // Выводим результат последовательного вычисления
    cout << "Среднее значение (последовательно): " << avgSeq << endl;

    // Выводим результат параллельного вычисления
    cout << "Среднее значение (параллельно OpenMP): " << avgPar << endl;

    // Освобождаем память, выделенную под динамический массив
    delete[] arr;

    // Возвращаем 0 — успешное завершение программы
    return 0;
}
